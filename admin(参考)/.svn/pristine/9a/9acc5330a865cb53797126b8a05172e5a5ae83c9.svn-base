<?php

namespace Admin\Controller;
namespace Admin\Controller;
use Admin\Common\Api\Api;
class TagController extends BaseController {
    private static $api_url = "http://chenkuanxin.catalog.com";
    //获取品牌列表
    public function searchTagList() {
        $url = self::$api_url."/Tag/searchTagList";
        if(I("param.")){
            $param = array();
            if(session("tag_search_list")){
               $param = array_merge(session("tag_search_list"),I("param."));
            }else{
               $param = I("param.");
               session("tag_search_list",$param); 
            }
            foreach($param as $key=>$val){
                if($val == ""){
                    unset($param[$key]);
                }
            }
            $param = !empty($param) ? $param : array();
            $taglist = Api::request($url,$param);
            $this->assign("searchVal",$param);
        }else{
            session('tag_search_list',null);
            $taglist = Api::request($url);
        }
        if($taglist[0]){
            $Page = new \Think\Page($taglist[0]["count"],10);
            $show = $Page->show();
            $this->assign('page',$show);
        }
        $tag_tpe = array(1=>"健康标签",2=>"安心度标签",3=>"敏感人群标签",4=>"促销标签");
        $this->assign("tag_type",$tag_tpe);
        $this->assign("taglist",$taglist[0]);
        $this->display();
     }
     //添加品牌
     public function addTag(){
        if(I("param.") || $_FILES){
            $flag = 1;
            $error = "";
            $check = array("name","priority","type");
            foreach($check as $key=>$val){
                if(!I("param.".$val)){
                    $flag = 0;
                    $error .= $val."不能为空 ";
                }
            }
            if($flag){
                $param = I("param.");
                if(isset($_FILES["pic_url"]["name"]) && !empty($_FILES["pic_url"]["name"])){
                    $tmp_name  =  $_FILES ["pic_url"]["tmp_name"];
                    $link = fdfs_upload($tmp_name,"jpg");
                    if($link["res"] && $link["data"]){
                        $param["pic_url"] = C('FDFS_DOWNLOAD_SERVER').$link["data"];
                    }else{
                        $this->error("文件上传失败");exit;
                    }
                }
                $url = self::$api_url."/Tag/addTag";
                $result = Api::request($url,$param,"post");
                if($result[0]["result"] == 1){
                    $this->success($result[0]["dis"]);exit;
                }else{
                    $this->success($result[0]["dis"]);exit;
                }
            }else{
                $this->error($error);exit;
            }
        }
    }
    //编辑品牌
     public function modifyTag(){
        if(I("param.dotype")){
            $url = self::$api_url."/Tag/searchTagDetail";
            $list = Api::request($url,array("tag_id"=>I("param.tag_id")));
            if($list[0]["result"] == 1){
                $this->assign("list",$list[0]["data"]);
                $this->show();exit;
            }else{
                echo "<font color='red'>".$list[0]["dis"]."</font>";exit;
            }   
        }else{
            $url = self::$api_url."/Tag/modifyTag";
            $check = array("name","priority","tag_id","type");
            $flag = 1;
            $error = "";
            foreach($check as $key=>$val){
                if(!I("param.".$val)){
                    $flag = 0;
                    $error .= $val."不能为空 ";
                }
            }
            if($flag){
                $param = I("param.");
                if(isset($_FILES["pic_url"]["name"]) && !empty($_FILES["pic_url"]["name"])){
                    $tmp_name  =  $_FILES ["pic_url"]["tmp_name"];
                    $link = fdfs_upload($tmp_name,"jpg");
                    if($link["res"] && $link["data"]){
                        $param["pic_url"] = C('FDFS_DOWNLOAD_SERVER').$link["data"];
                    }else{
                        $this->error("文件上传失败");exit;
                    }
                }
                $url = self::$api_url."/Tag/modifyTag";
                $result = Api::request($url,$param,"post");
                if($result[0]["result"] == 1){
                    $this->success($result[0]["dis"]);exit;
                }else{
                    $this->success($result[0]["dis"]);exit;
                }
            }else{
                $this->error($error);exit;
            }
        } 
    }
    //删除品牌
    function deleteTag(){
        if(I("param.tag_id")){
            $data["tag_id"] = I("param.tag_id");
            $url = self::$api_url."/Tag/deleteTag";
            print_r();
            $result = Api::request($url,$data);
            echo json_encode($result[0]);exit;
        }else{
             $this->success("Tag_id为空或者不存在");exit;
        }
    }
}
